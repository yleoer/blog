---
title: 程序结构 | Go 语言圣经
date: 2021-04-27 10:20:11
tags: Golang
categories: 编程语言
---

《Go 语言圣经》 读书笔记 —— 程序结构

<!-- more -->

Go 语言和其他编程语言一样，一个大的程序是由很多小的基础构建组成的。

## 命名

GO 语言中的函数名、变量名、常量名、类型名、语句标号和包名等所有命名，都遵循同一个命名规则：**必须以字母或下划线开头，后面可以跟任意数量的字母、数字或下划线。区分大小写。**

**关键字**：Go 语言有 25 个关键字，关键字不能用于自定义名字，只能在特定语法结构中使用。

```txt
break    default     func   interface select
case     defer       go     map       struct
chan     else        goto   package   switch
const    fallthrough if     range     type
continue for         import return    var
```

**保留字**：Go 语言有 30 多个保留字，主要对应内件的常量、类型和函数。

```txt
内建常量：true false iota nil

内建类型：int int8 int16 int32 int64
		uint uint8 uint16 uint32 uint64 uintptr
		float32 float64 complex128 complex64
		bool byte rune string error

内建函数：make len cap new append copy close delete
		cpmplex real imag
		panic recover
```

如果定义在函数外部的名字或函数名以大写字母开头的，那么它是公共的，可以被外部访问。如果是小写字母开头，则是私有的，不能被导出。

习惯上，Go 语言推荐使用驼峰式命名：当名字由几个单词组成时使用大小写分隔。对于如 HTML 这样的缩略词，避免使用大小写混合的写法，可以是 htmlEscape、HTMLEscape 或 escapeHTML，但不能是 escapeHtml。

## 声明

Go 语言主要由四种类型的声明语句：`var`、`const`、`type` 和 `func`，分别对于变量、常量、类型和函数实体对象的声明。

每一个 Go 源文件都以包的声明语句开始，说明该源文件是属于哪个包。包声明语句之后是 `import` 语句导入依赖的其它包，然后是包一级的类型、变量、常量、函数的声明语句。

```go
package main

import "fmt"

const boilingF = 212.0

func main() {
    var freezingF = 32.0
    fmt.Printf("%g°F = %g°C\n", freezingF, fToC(freezingF)) // "32°F = 0°C"
    fmt.Printf("%g°F = %g°C\n", boilingF, fToC(boilingF))   // "212°F = 100°C"
}

// fToC 根据华氏温度 <f> 返回摄氏温度
func fToC(f float64) float64 {
    return (f - 32) * 5 / 9
}
```

## 变量

### 关键字声明

变量声明的一般语法是 `var 变量名字 类型 = 表达式`。

其中 `类型` 和 `= 表达式` 这两个部分可以省略其中一个。如果省略的是类型信息，那么将根据初始化表达式来推导变量的类型信息。如果初始表达式被省略，那么将用零值来初始化变量。

- 数值类型变量对应的零值是 `0`
- 布尔类型变量对应的零值是 `false`
- 字符串类型对应的零值是空字符串 `""`
- 接口或引用类型变量对应的零值是 `nil`
- 数组或结构体等聚合类型对应的零值是每个元素或字段都是对应类型的零值

> 零值初始化机制可以确保每个声明的变量总是有一个良好定义的值，因此在 Go 语言中不存在未初始化的变量。

可以在一个声明语句中同时声明一组变量，或用一组初始化表达式声明并初始化一组变量。

```go
var i, j, k int
var b, f, s = true, 2.3, "four"
var f, err = os.Open(name)
```

### 简短声明

在**函数内部**，有一种更为简洁的变量声明语句：`变量名 := 表达式`，变量的类型根据表达式自动推导。

```go
t := 0.0
i, j := 0, 1
anim := gif.GIF{LoopCount: nframes}
freq := rand.Float64() * 3.0
```

简短声明被广泛用于局部变量的声明和初始化，`var` 关键字声明语句往往是用于需要显示指定变量类型的地方，或者因为变量稍后会被重新赋值而初始值无关紧要的地方。

```go
i := 100 // an int
var boiling float64 = 100 // an float64
```

**`:=` 是一个变量声明语句，而 `=` 是一个变量赋值操作。**所以 GO 语言中交换两个变量的值极其简单。

```go
i, j = j, i // 交换 i 和 j 的值
```

另外，简短变量声明左边的变量可以不全都是未声明的变量，如果有部分已声明过，那么对应变量就只有赋值行为了。

```go
in, err := os.Open(infile)
// ...
out, err := os.Create(outfile)
```

### 指针

一个指针的值是另一个变量的地址，是对应变量在内存中的存储位置。通过指针，我们直接读或者更新变量的值。

```go
x := 1
p := &x // 类型为 *int，指向 x
fmt.Println(*p) // 1
*p = 2
fmt.Println(x) // 2
```

### new 函数

另一个创建变量的方法就是调用内建的 `new` 函数，`new(T)` 函数会创建一个 `T` 类型的匿名变量，初始化为对应类型的零值，然后返回变量地址，返回的指针类型为 `*T`。

```go
p := new(int) // 类型为 *int，指向匿名的 int 变量
```

### 变量的声明周期

变量的声明周期指的是在程序运行期间变量有效存在时间段。

对于在包一级声明的变量来说，它们的生命周期和整个程序的运行周期是一致的。局部变量的生命周期则是动态的：每次从创建一个新变量的声明语句开始，直到该变量不再被引用位置，然后变量的存储空间可能被回收。

## 赋值

### 赋值语句

使用赋值语句可以更新一个变量的值。

```go
x = 1
*p = true
count[x] *= scale
x++
```

{% note warning %}

在 Go 预言中自增和自减是语句，不是表达式，因此 `x = i++` 之类的表达式是错误的

{% endnote %}

### 元组赋值

元组赋值是另一种形式的赋值语句，它允许同时更新多个变量的值。

```go
i, j, k = 2, 3, 5
x, y = y, x
a[i], a[j] = a[j], a[i]
v, ok = m[key]
```

## 类型

变量或表达式的类型定义了对应存储值的属性特征，例如数值在内存的存储大小，它们在内部是如何表达的，是否支持一些操作符，以及它们自己关联的方法集等。

一个类型声明语句 `type 类型名字 底层类型` 创建了一个新的类型名称，和现有类型具有相同的底层结构。新命名的类型提供了一个方法，用来分隔不同概念的类型，这样即使它们底层类型相同也是不兼容的。

## 包和文件

Go 语言中的包是为了支持模块化、封装、单独编译和代码重用。

一个包的源代码保存在一个或多个以 `.go` 为文件后缀名的源文件中，每个包都对应一个独立的命名空间。

每个包都有一个全局唯一的导入路径，还有一个包名，一般是导入路径的最后一个字段。

函数 `init` 除了不能被调用或引用外，其他行为和普通函数类似，在程序开始执行时按照它们的声明顺序自动调用。

## 作用域

声明语句的作用域对应的是一个源代码的文本区域，它是一个编译时的属性。一个变量的生命周期是指程序运行时变量存在的有效时间段，在此时间区域内它可以被程序的其他部分引用，是一个运行时的概念。

[^1]: [Go 语言圣经](https://github.com/golang-china/gopl-zh)
[^2]: [The Go Programming Language](http://www.gopl.io/)